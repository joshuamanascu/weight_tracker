<html>
	<head>
		<meta name = "viewport" content = "width=device-width, initial-scale = 1.0">
		<link rel="stylesheet" type="text/css" href="styles.css" />
		
		<script>
			
			window.onload = function() {
				
				localDate = getCurrentDateString();
				document.getElementById("date_select").value = localDate;
				
				loadCalories(localDate);
			}
			
			function getCurrentDateString() {
				const today = new Date();
				const year = today.getFullYear(); // Local year
				const month = String(today.getMonth() + 1).padStart(2, '0'); // Local month (0-based index, so add 1)
				const day = String(today.getDate()).padStart(2, '0'); // Local day

				// Format the date as YYYY-MM-DD
				const localDate = `${year}-${month}-${day}`;
				
				return localDate;
			}
			
			//Change the Calories meter
			function loadCalories(date) {
				
				const progressBar = document.getElementById("calories_bar");
				const progressText = document.getElementById("calories_text");
				
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.onreadystatechange = function() { 
					if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
						progressBar.value = xmlHttp.responseText;
						progressText.innerHTML = xmlHttp.responseText + "/1800";
					}
				}
				
				xmlHttp.open("POST", "http://144.126.152.214:8000/weight", true);
				//xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
				
				const type = "get_calories";
				
				const request = `request_type=${type}&date_requested=${date}`;
				
				xmlHttp.overrideMimeType("text/html");
				xmlHttp.send(request);
				
			}
			
			function submitCalories() {
				var xmlHttp = new XMLHttpRequest();
				
				const responseLabel = document.getElementById("response_label");
				
				xmlHttp.onreadystatechange = function() { 
					if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
						responseLabel.innerHTML = "Added successfully!"
						responseLabel.style.display = "block";
						
						loadCalories(getCurrentDateString());
						
						//Remove message after 5 seconds
						setTimeout(function() {
							responseLabel.style.display = "none";
						}, 5000)
						
					}
					else if (xmlHttp.readyState == 4 && xmlHttp.status == 500) {
						responseLabel.innerHTML = "Error - Not added!"
						responseLabel.style.display = "block";
						
						setTimeout(function() {
							responseLabel.style.display = "none";
						}, 5000)
					}
							
				}
				
				xmlHttp.open("POST", "http://144.126.152.214:8000/weight", true);
				//xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
				
				xmlHttp.overrideMimeType("text/html");
				var formData = new FormData(document.getElementById("form_eat"));
				xmlHttp.send(new URLSearchParams(formData))
				
				
			}
		</script>
	</head>
	<body>
		<div class="grid-parent">
			<!-- HEADER -->
			<div class="header">
				<h2 style="text-align: center; margin-top: 40px;">Weight Tracking</h2>
			</div>
			
			<div class="today">
				<h3 style="text-align: center; margin-top: 40px; ">Current Stats</h3>
				
				<div class="calories_progress">
					<label style="display:inline-block; margin-top:10%;">Calories Today:</label>
					<br>

					<meter style="width:60%;" id="calories_bar" min="0" low="1500" high="1700" max="1800" value="0"></meter>
					<br>
					<h4 id="calories_text">0/1800</h4>
				</div>

			</div>
			
			<div class="insert">
				<h3 style="text-align: center; margin-top: 40px; grid-column: 1/13; grid-row: 1;">Insert</h2>
				
				<div class="form_eat">
					<form id="form_eat" name="eat" action="" method="post">
						<input style="margin-top:20px;" type="date" id="date_select" name="date_eaten">
						<input style="margin-top:20px;" size="4" type="text" id="calories_input" name="calories">
						
						<!-- Request type -->
						<input name="request_type" type="hidden" value="insert_calories">
					</form>
					
					<button onclick="submitCalories()">Add</button>
					<br><br>
					<label id="response_label" style="color: green; display:none;">Added successfully!</label>
				</div>
				
				<div class="food_list">
					
				</div>
			</div>
		</div>
	</body>
</html>
